#!/usr/bin/perl

# Copyright 2002-2013, Paul Johnson (paul@pjcj.net)

# This software is free.  It is licensed under the same terms as Perl itself.

# The latest version of this software should be available from my homepage:
# http://www.pjcj.net

require 5.6.1;

use strict;
use warnings;

# VERSION

use lib qw( ./lib );
use Devel::Cover::DB;
use Devel::Cover::Dumper;
use Devel::Cover::cpancover::Defaults qw(
    %defaults
    get_options
);
use Devel::Cover::cpancover::Template::Provider;
use Devel::Cover::cpancover qw(
    read_results
    write_html
    get_cover
);

use Fcntl ":flock";
use Getopt::Long;
use Template 2.00;
use Parallel::Iterator "iterate_as_array";

# use Carp; $SIG{__DIE__} = \&Carp::confess;

$|++;

my $Options = semi_get_options();

my $Template = Template->new( {
    LOAD_TEMPLATES =>
    [
        Devel::Cover::cpancover::Template::Provider->new({}),
    ],
} );

if ($Options->{collect}) {
    my $workers = $ENV{CPANCOVER_WORKERS} || 0;
    my @res = iterate_as_array
    (
        { workers => $workers },
        sub {
            eval {
              get_cover ($_[1], $Options);
              warn "\n\n\n[$_[1]]: $@\n\n\n" if $@;
          };
        },
        $Options->{module},
    );
}

write_html($Options);

######### SUBROUTINES ##########

sub semi_get_options {
    $Options = get_options(\%defaults);

    print "$0 version " . __PACKAGE__->VERSION . "\n" and exit 0
        if $Options->{version};
    pod2usage(-exitval => 0, -verbose => 0)  if $Options->{help};
    pod2usage(-exitval => 0, -verbose => 2)  if $Options->{info};

    $Options->{outputdir}  ||= $Options->{directory};
    $Options->{outputfile} ||= "coverage.html";
    push @{$Options->{module}}, @ARGV;
    if (!$Options->{redo_cpancover_html} && !@{$Options->{module}})
    {
        my $d = $Options->{directory};
        opendir my $D, $d or die "Can't opendir $d: $!\n";
        @{$Options->{module}} = grep !/^\./ && -e "$d/$_/Makefile.PL",
                                     sort readdir $D
            or die "No module directories found\n";
        closedir $D or die "Can't closedir $d: $!\n";
    }
    return $Options;
}

__END__

=head1 NAME

cpancover - report coverage statistics on CPAN modules

=head1 SYNOPSIS

 cpancover -help -info -version

=head1 DESCRIPTION


=head1 OPTIONS

The following command line options are supported:

 -h -help              - show help
 -i -info              - show documentation
 -v -version           - show version

=head1 DETAILS


=head1 REQUIREMENTS

The modules L<Template> and L<Parallel::Iterator> are required.

=head1 EXIT STATUS

The following exit values are returned:

0   All operations were completed successfully.

>0  An error occurred.

=head1 SEE ALSO

 L<Devel::Cover>

=head1 BUGS

 Incomplete.
 Undocumented.
 Needs to be redone properly.

=head1 LICENCE

Copyright 2002-2013, Paul Johnson (paul@pjcj.net)

This software is free.  It is licensed under the same terms as Perl itself.

The latest version of this software should be available from my homepage:
http://www.pjcj.net

=cut
